
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
    <title>6.数据库原理 | 不完整的旋律的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="大圣">
    

    
    <meta name="description" content="事务指的是满足ACID特性的一系列操作。可以通过commit提交一个事务，也可以使用rollback进行回滚。   原子性（Atomicity）事务中所有操作是不可分割的原子单位，要么全部成功，要么全部失败。  一致性数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。 隔离性在并发操作下，不同的事务应该隔离开来，相对不可见。 持久性一旦事务提交，其所作的">
<meta name="keywords" content="数据库 MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="6.数据库原理">
<meta property="og:url" content="https://WangLeiHH.github.io/2019/02/28/6-数据库原理/index.html">
<meta property="og:site_name" content="不完整的旋律的博客">
<meta property="og:description" content="事务指的是满足ACID特性的一系列操作。可以通过commit提交一个事务，也可以使用rollback进行回滚。   原子性（Atomicity）事务中所有操作是不可分割的原子单位，要么全部成功，要么全部失败。  一致性数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。 隔离性在并发操作下，不同的事务应该隔离开来，相对不可见。 持久性一旦事务提交，其所作的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.imgur.com/vVKozW2.jpg">
<meta property="og:image" content="https://i.imgur.com/FxZ3mEz.jpg">
<meta property="og:updated_time" content="2019-03-01T09:25:41.498Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="6.数据库原理">
<meta name="twitter:description" content="事务指的是满足ACID特性的一系列操作。可以通过commit提交一个事务，也可以使用rollback进行回滚。   原子性（Atomicity）事务中所有操作是不可分割的原子单位，要么全部成功，要么全部失败。  一致性数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。 隔离性在并发操作下，不同的事务应该隔离开来，相对不可见。 持久性一旦事务提交，其所作的">
<meta name="twitter:image" content="https://i.imgur.com/vVKozW2.jpg">

    
    <link rel="alternative" href="/atom.xml" title="不完整的旋律的博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/222.gif" alt="不完整的旋律的博客" title="不完整的旋律的博客"></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="不完整的旋律的博客">不完整的旋律的博客</a></h1>
				<h2 class="blog-motto">爱生活爱编程</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/tags">标签</a></li>
					
						<li><a href="/categories">分类</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索">
						<input type="hidden" name="q" value="site:WangLeiHH.github.io">
					</form>
					
					</li>
				</ul>
			</ul></nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope="" itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/02/28/6-数据库原理/" title="6.数据库原理" itemprop="url">6.数据库原理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大圣" target="_blank" itemprop="author">大圣</a>
		
  </p><p class="article-time">
    <time datetime="2019-02-28T03:42:01.000Z" itemprop="datePublished"> 发表于 2019-02-28</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#事务"><span class="toc-number">1.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原子性（Atomicity）"><span class="toc-number">1.1.</span> <span class="toc-text">原子性（Atomicity）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一致性"><span class="toc-number">1.2.</span> <span class="toc-text">一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隔离性"><span class="toc-number">1.3.</span> <span class="toc-text">隔离性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#持久性"><span class="toc-number">1.4.</span> <span class="toc-text">持久性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AUTOCOMMIT"><span class="toc-number">1.5.</span> <span class="toc-text">AUTOCOMMIT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并发一致性问题"><span class="toc-number">1.6.</span> <span class="toc-text">并发一致性问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#封锁"><span class="toc-number">2.</span> <span class="toc-text">封锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#封锁粒度"><span class="toc-number">2.1.</span> <span class="toc-text">封锁粒度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#封锁类型"><span class="toc-number">2.2.</span> <span class="toc-text">封锁类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-读写锁"><span class="toc-number">2.2.0.0.1.</span> <span class="toc-text">1.读写锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-意向锁"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.意向锁</span></a></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#封锁协议"><span class="toc-number">2.3.</span> <span class="toc-text">封锁协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-三级封锁协议"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.三级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一级封锁协议"><span class="toc-number">2.3.2.</span> <span class="toc-text">一级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二级封锁协议"><span class="toc-number">2.3.3.</span> <span class="toc-text">二级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三级封锁协议"><span class="toc-number">2.3.4.</span> <span class="toc-text">三级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#两段锁协议"><span class="toc-number">2.3.5.</span> <span class="toc-text">两段锁协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL隐式与显示锁定"><span class="toc-number">3.</span> <span class="toc-text">MySQL隐式与显示锁定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#隔离级别"><span class="toc-number">4.</span> <span class="toc-text">隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#未提交读-READ-UNCOMMITTED"><span class="toc-number">4.1.</span> <span class="toc-text">未提交读(READ UNCOMMITTED)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提交读（READ-COMMITTED）"><span class="toc-number">4.2.</span> <span class="toc-text">提交读（READ COMMITTED）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可重复读（REPEATABLE-READ）"><span class="toc-number">4.3.</span> <span class="toc-text">可重复读（REPEATABLE READ）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可串行化"><span class="toc-number">4.4.</span> <span class="toc-text">可串行化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多版本并发控制"><span class="toc-number">5.</span> <span class="toc-text">多版本并发控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#版本号"><span class="toc-number">5.1.</span> <span class="toc-text">版本号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隐藏的列"><span class="toc-number">5.2.</span> <span class="toc-text">隐藏的列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL索引"><span class="toc-number">6.</span> <span class="toc-text">MySQL索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-B-Tree索引"><span class="toc-number">6.1.</span> <span class="toc-text">1.B+Tree索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-哈希索引"><span class="toc-number">6.2.</span> <span class="toc-text">2.哈希索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-全文索引"><span class="toc-number">6.3.</span> <span class="toc-text">3.全文索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-空间数据索引"><span class="toc-number">6.4.</span> <span class="toc-text">4.空间数据索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引优化"><span class="toc-number">7.</span> <span class="toc-text">索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-独立的列"><span class="toc-number">7.1.</span> <span class="toc-text">1.独立的列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-前缀索引"><span class="toc-number">7.2.</span> <span class="toc-text">4.前缀索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-覆盖索引"><span class="toc-number">7.3.</span> <span class="toc-text">5.覆盖索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引的优点"><span class="toc-number">8.</span> <span class="toc-text">索引的优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引的使用条件"><span class="toc-number">9.</span> <span class="toc-text">索引的使用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询性能优化"><span class="toc-number">10.</span> <span class="toc-text">查询性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Explain-进行分析"><span class="toc-number">10.1.</span> <span class="toc-text">使用 Explain 进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化数据访问"><span class="toc-number">10.2.</span> <span class="toc-text">优化数据访问</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-减少请求的数据量"><span class="toc-number">10.2.1.</span> <span class="toc-text">1.减少请求的数据量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-减少服务器端扫描的行数"><span class="toc-number">10.2.2.</span> <span class="toc-text">2.减少服务器端扫描的行数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重构查询方式"><span class="toc-number">10.3.</span> <span class="toc-text">重构查询方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-切分大查询"><span class="toc-number">10.3.1.</span> <span class="toc-text">1.切分大查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分解大连接查询"><span class="toc-number">10.3.2.</span> <span class="toc-text">分解大连接查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储引擎"><span class="toc-number">11.</span> <span class="toc-text">存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB"><span class="toc-number">11.1.</span> <span class="toc-text">InnoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyISAM"><span class="toc-number">11.2.</span> <span class="toc-text">MyISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较"><span class="toc-number">11.3.</span> <span class="toc-text">比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#切分"><span class="toc-number">12.</span> <span class="toc-text">切分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#水平切分"><span class="toc-number">12.1.</span> <span class="toc-text">水平切分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#垂直切分"><span class="toc-number">12.2.</span> <span class="toc-text">垂直切分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sharding策略"><span class="toc-number">12.3.</span> <span class="toc-text">Sharding策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sharding存在的问题"><span class="toc-number">12.4.</span> <span class="toc-text">Sharding存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-事务问题"><span class="toc-number">12.4.1.</span> <span class="toc-text">1.事务问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#连接"><span class="toc-number">12.4.2.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ID唯一性"><span class="toc-number">12.4.3.</span> <span class="toc-text">ID唯一性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复制"><span class="toc-number">13.</span> <span class="toc-text">复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#主从复制"><span class="toc-number">13.1.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读写分离"><span class="toc-number">13.2.</span> <span class="toc-text">读写分离</span></a></li></ol></li>
		
		</div>
		
		<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>指的是满足ACID特性的一系列操作。<br>可以通过commit提交一个事务，也可以使用rollback进行回滚。  </p>
<h3 id="原子性（Atomicity）"><a href="#原子性（Atomicity）" class="headerlink" title="原子性（Atomicity）"></a>原子性（Atomicity）</h3><p>事务中所有操作是不可分割的原子单位，要么全部成功，要么全部失败。 </p>
<h3 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h3><p>数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。</p>
<h3 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h3><p>在并发操作下，不同的事务应该隔离开来，相对不可见。</p>
<h3 id="持久性"><a href="#持久性" class="headerlink" title="持久性"></a>持久性</h3><p>一旦事务提交，其所作的修改将会永远保存到数据库中。即使数据库崩溃，事务执行的结果也不能丢失。使用重做日志来保证持久性。</p>
<h3 id="AUTOCOMMIT"><a href="#AUTOCOMMIT" class="headerlink" title="AUTOCOMMIT"></a>AUTOCOMMIT</h3><p>MySQL默认采用自动提交模式。也就是说，如果不显示使用START TRANSACTION语句来开始一个事务，那么每个查询都会被当做一个事务自动提交。</p>
<h3 id="并发一致性问题"><a href="#并发一致性问题" class="headerlink" title="并发一致性问题"></a>并发一致性问题</h3><p>在并发环境下，事务的隔离性很难保证，因此会出现喝多并发一致性的问题。  </p>
<ul>
<li>丢失修改：T1和T2两个事务对同一个数据进行修改，T1先修改，T2后修改，T2的修改覆盖了T1的修改。  </li>
<li>脏读：读取到另一个事务未提交的数据  T1修改了一个数据，T2随后读取这个数据。如果T1撤销了这次修改，那么T2读取的数据是脏数据。</li>
<li>不可重复读： 两次读取数据不一致。已提交（update）<br>T2读取一个数据，T1对对该数据进行了修改。如果T2再次读取这个数据，此时读取的结果和第一次读取的结果不同。</li>
<li>幻读： 读另一个事务已提交的数据（instert）  </li>
</ul>
<p>T1读取一个范围的数据，T2在这个范围内插入新的数据，T1再次读取这个范围的数据，此时读取的结果和第一次读取的结果不同。</p>
<hr>
<p>产生并发不一致问题的主要原因是破坏了事务的隔离性，解决方法是通过并发控制来保证隔离性。并发控制可以通过封锁来实现，但是封锁操作需要用户自己控制，相当复杂。数据库管理员系统提供了事务的隔离性，让用户以一种更轻松的方式处理并发一致性问题。</p>
<h2 id="封锁"><a href="#封锁" class="headerlink" title="封锁"></a>封锁</h2><h3 id="封锁粒度"><a href="#封锁粒度" class="headerlink" title="封锁粒度"></a>封锁粒度</h3><p>MySQL中提供了两种封锁粒度：行级锁及表级锁。</p>
<p>应该尽量只锁定需要修改的那部分数据，而不是所有的资源。锁定的数据量越小，发生锁争用的可能就越小，系统的并发成都就越高。  </p>
<p>但是加锁需要消耗资源，锁的各种操作（包括获取锁，释放锁，以及检查锁状态）都会增加系统开销。因此封锁粒度越小，系统开销就越大。</p>
<p>在选择封锁粒度时，需要在锁开销和并发程度之间做一个权衡。</p>
<h3 id="封锁类型"><a href="#封锁类型" class="headerlink" title="封锁类型"></a>封锁类型</h3><h6 id="1-读写锁"><a href="#1-读写锁" class="headerlink" title="1.读写锁"></a>1.读写锁</h6><ul>
<li>排它锁，简称X锁，又称写锁。</li>
<li>共享锁，简称S锁，又称读锁。</li>
</ul>
<p>有以下两个规定：</p>
<ul>
<li>一个事务对数据对象A加了X锁，就可以对A进行读取和更新。加锁期间其他事务不能对A加任何锁。</li>
<li>一个事务对数据对象A加了S锁，就可以对A进行读取操作，但是不能进行更新操作。加锁期间其它事务能对A加S锁。但是不能加X锁。<h4 id="2-意向锁"><a href="#2-意向锁" class="headerlink" title="2.意向锁"></a>2.意向锁</h4>使用意向锁可以更容易地支持多粒度封锁。  </li>
</ul>
<p>在存在行级锁和表级锁的情况下，事务T想要对表A加X锁，就需要先检测是否有其它事务对表A或者表A中的任意一行加了锁，那么就需要对表A的每一行多检测一次，这是非常消耗性能的。</p>
<p>意向锁在原来的X/S锁之上引入了IX/IS,IX/IS都是表锁，用来表示一个事务想要在表中的某个数据行上加X锁或S锁。有以下两个规定：</p>
<ul>
<li>一个事务在获得某个数据行对象的S锁之前，必须先获得表的IS锁或者更强的锁。</li>
<li>一个事务在获得某个数据对象的X之前，必须先获得表的IX锁。</li>
</ul>
<p>通过引入意向锁，事务T想要对表A加X锁，只需要先检测是否有其他事务对表A加了X/IX/S/IS锁，如果加了就表示有其他事务正在使用这个表或者表中某一行的锁，因此事务T加X锁失败。</p>
<ul>
<li>任意IS/IX锁之间都是兼容的，因为他们只是表示想要对表加锁，而不是真正加锁；  </li>
<li>S锁只与S锁和IS锁兼容，也就是说事务T想要对数据行加S锁，其他事务可以已经获得对表或者表中的行的S锁。<h3 id="封锁协议"><a href="#封锁协议" class="headerlink" title="封锁协议"></a>封锁协议</h3><h4 id="1-三级封锁协议"><a href="#1-三级封锁协议" class="headerlink" title="1.三级封锁协议"></a>1.三级封锁协议</h4><h4 id="一级封锁协议"><a href="#一级封锁协议" class="headerlink" title="一级封锁协议"></a>一级封锁协议</h4>事务T要修改数据A时必须要加X锁，直到T结束才释放锁。</li>
</ul>
<p>可以解决丢失修改问题，因为不能同时有两个事务对同一数据进行修改，那么书屋的修改就不会被覆盖。</p>
<h4 id="二级封锁协议"><a href="#二级封锁协议" class="headerlink" title="二级封锁协议"></a>二级封锁协议</h4><p>在一级的基础上，要求读取数据A时必须加S锁，读取完马上释放S锁。</p>
<p>可以解决脏读的问题，因为如果一个事务在对数据A进行修改，根据1级封锁协议，会加X锁,那么就不能再加S锁了，也就是不会读入数据。</p>
<h4 id="三级封锁协议"><a href="#三级封锁协议" class="headerlink" title="三级封锁协议"></a>三级封锁协议</h4><p>在二级的基础上，要求读取数据A时必须加S锁，直到事务结束了才能释放S锁。</p>
<p>可以解决不可重复读的问题，因为读A时，其他事务不能对A加X锁，从而避免了在读的期间数据发生变化。</p>
<h4 id="两段锁协议"><a href="#两段锁协议" class="headerlink" title="两段锁协议"></a>两段锁协议</h4><p>加锁和解锁分为两个阶段进行。</p>
<p>可串行化调度是指，通过并发控制，使得并发执行的事务结果与某个串行执行的事务结果相同。</p>
<p>事务遵循两段锁协议是保证可串行化调度的充分条件。</p>
<h2 id="MySQL隐式与显示锁定"><a href="#MySQL隐式与显示锁定" class="headerlink" title="MySQL隐式与显示锁定"></a>MySQL隐式与显示锁定</h2><p>MySQL的InnoDB存储引擎采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放，这被称为隐式锁定。</p>
<p>InnoDB也可以使用特定的语句进行显示锁定：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT ... LOCK In SHARE MOOE;</span><br><span class="line">SELECT ... FOR UPDTE;</span><br></pre></td></tr></table></figure></p>
<h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><h3 id="未提交读-READ-UNCOMMITTED"><a href="#未提交读-READ-UNCOMMITTED" class="headerlink" title="未提交读(READ UNCOMMITTED)"></a>未提交读(READ UNCOMMITTED)</h3><p>事务中的修改，即使没有提交，对其他事务也是可见的。</p>
<p>可能出现任何事务并发问题，性能最好</p>
<h3 id="提交读（READ-COMMITTED）"><a href="#提交读（READ-COMMITTED）" class="headerlink" title="提交读（READ COMMITTED）"></a>提交读（READ COMMITTED）</h3><p>一个事务只能读取已经提交的事务所作的修改。换句话说，一个事务所做的修改在提交之前对其他事务是不可见的的</p>
<p>防止脏读</p>
<h3 id="可重复读（REPEATABLE-READ）"><a href="#可重复读（REPEATABLE-READ）" class="headerlink" title="可重复读（REPEATABLE READ）"></a>可重复读（REPEATABLE READ）</h3><p>保证在同一事务中多次读取同样数据的结果是一样的。  </p>
<p>防止不可重复读和脏读，幻读可能发生。</p>
<h3 id="可串行化"><a href="#可串行化" class="headerlink" title="可串行化"></a>可串行化</h3><p>强制事务串行执行。  </p>
<p>不会出现任何并发问题。对同一数据的访问是串行的，非并发。</p>
<p>性能最差</p>
<h2 id="多版本并发控制"><a href="#多版本并发控制" class="headerlink" title="多版本并发控制"></a>多版本并发控制</h2><p>多版本并发控制是MySQL的InnoDB存储引擎实现隔离级别的一种具体实现方式，用于实现提交读和重复读这两种隔离级别。而未提交读隔离级别总是读取最新的数据行，无需使用MVCC.可串行化隔离级别需要对所有读取的行都加锁，单纯使用MVCC无法实现。</p>
<h3 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h3><ul>
<li>系统版本号：是一个递增的数字，每开始一个新的事物，系统版本号就会自动递增。</li>
<li>事务版本号：事务开始时的版本号。<h3 id="隐藏的列"><a href="#隐藏的列" class="headerlink" title="隐藏的列"></a>隐藏的列</h3>MVCC在每行记录后面都保存着两个隐藏的列，用来存储两个版本号：</li>
<li>创建版本号：指示创建一个数据行的快照时的系统版本号；</li>
<li>删除版本号：如果该快照的删除版本号大于当前事务版本号表示该快照有效，否则表示该快照应经被删除了。<h2 id="MySQL索引"><a href="#MySQL索引" class="headerlink" title="MySQL索引"></a>MySQL索引</h2>索引是在存储引擎层实现的，而不是在服务器层实现的，所以不同存储引擎具有不同的索引类型和实现。<h3 id="1-B-Tree索引"><a href="#1-B-Tree索引" class="headerlink" title="1.B+Tree索引"></a>1.B+Tree索引</h3>是大多数MySQL存储引擎的默认索引类型。</li>
</ul>
<p>因为不在需要进行全表扫描，只需要对树进行搜索即可，所以查找速度很快。</p>
<p>除了用于查找，还可以用于排序和分组。</p>
<p>可以指定多个列作为索引列，多个索引列共同组成键。</p>
<p>适用于全键值，键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找。如果不是按照索引列的顺序进行查找，则无法使用索引。 </p>
<p>InnoDB的B+Tree索引分为主索引和辅助索引。主索引的叶子节点data域记录着完整的数据记录、这种索引方式被称为聚簇索引。因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p>
<p>辅助索引的叶子节点的data域记录着主键的值，因此在使用辅助索引进行查找时，需要先查找到主键，然后再到主索引中进行查找。</p>
<h3 id="2-哈希索引"><a href="#2-哈希索引" class="headerlink" title="2.哈希索引"></a>2.哈希索引</h3><p>哈希索引能以o（1）时间进行查找，但是失去了有序性：</p>
<ul>
<li>无法用于排序和分组；</li>
<li>只支持精确查找，无法用于部分查找和范围查找。</li>
</ul>
<p>InnoDB存储引擎有一个特殊的功能叫”自适应哈希索引”，当某个索引值被使用的非常频繁时，会在B+tree索引之上再创建一个哈希索引，这样就让B+Tree索引具有哈希索引的一些优点，比如快速的哈希查找。</p>
<h3 id="3-全文索引"><a href="#3-全文索引" class="headerlink" title="3.全文索引"></a>3.全文索引</h3><p>MyISAM存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较是否相等。</p>
<p>查找条件使用MATCH AGAINST,而不是普通的WHERE。</p>
<p>全文索引使用倒排序索引实现，它记录着关键词到其所在文档的映射。</p>
<p>InnoDB存储引擎在MyAQL5.6.4版本中也开始支持全文索引。</p>
<h3 id="4-空间数据索引"><a href="#4-空间数据索引" class="headerlink" title="4.空间数据索引"></a>4.空间数据索引</h3><p>MyISAM存储引擎支持空间数据索引（R-Tree），可以用于地理数据存储。空间数据索引会从所有维度来索引数据，可以有效地使用任意维度来组合查询。</p>
<p>必须使用GIS相关的函数来维护数据。</p>
<h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><h3 id="1-独立的列"><a href="#1-独立的列" class="headerlink" title="1.独立的列"></a>1.独立的列</h3><p>在进行查询时，索引列不是表达式的一部分，也不是函数的参数，否则无法使用索引。</p>
<figure class="highlight plain"><figcaption><span>id from user where id +1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 2.多列索引 ###</span><br><span class="line">在需要使用多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好。</span><br><span class="line">```select user_id,teacher_id from user where user_id =1 and teacher_id =1;```把user_id和techer_id设置为多列索引。</span><br><span class="line">### 3.索引列的顺序 ###</span><br><span class="line">让选择性最强的索引列放在前面。</span><br><span class="line">  </span><br><span class="line">索引的选择性是指：不重复的索引值和记录总数的比值。最大值为1，此时每个记录都有唯一的索引与其对应。选择性越高，查询效率也越高。</span><br><span class="line">  </span><br><span class="line">```select count(DISTINCT user_id)/count(*) as user_id_selectivity,</span><br><span class="line">  count (DISTINCT teacher_id)/count(*) as teacher_id_selectivity,</span><br><span class="line"> count(*) from payment;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   user_id_selectivity: 0.0001</span><br><span class="line">teacher_id_selectivity: 0.0373</span><br><span class="line">               COUNT(*): 16049</span><br></pre></td></tr></table></figure>
<p>techer_id的选择性比USER_id的选择性更高，因此最好把teacher_id列放在多列索引的前面。</p>
<h3 id="4-前缀索引"><a href="#4-前缀索引" class="headerlink" title="4.前缀索引"></a>4.前缀索引</h3><p>对于BLOB、TEXT和VARCHAR类型的列，必须使用前缀索引，只索引开始的部分字符。</p>
<p>对于前缀长度的选取需要根据索引选择性来确定。</p>
<h3 id="5-覆盖索引"><a href="#5-覆盖索引" class="headerlink" title="5.覆盖索引"></a>5.覆盖索引</h3><p>索引包含所有需要查询的字段的值。</p>
<p>具有以下优点：</p>
<ul>
<li>索引通常远小于数据行的大小，只读取索引能大大减少数据访问量。</li>
<li>一些存储引擎（例如MyISAM）在内存中只缓存索引，而数据依赖于操作系统来缓存。因此，只访问索引可以不使用系统调用（通常比较耗时）。</li>
<li>对于InnoDB引擎，若辅助索引能够覆盖查询，则无需访问主索引。<h2 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h2></li>
<li>大大减少了服务器需要扫描的数据行数。</li>
<li>帮助服务器避免进行排序和分组，以及避免创建临时表（B+TREE索引是有序的，可以用于ORDER BY和 GROUP BY操作。链式表主要是在排序和分组过程中创建，因为不需要排序和分组，也就不需要创建临时表）。</li>
<li>将随机I/O变为顺序I/O（B+Tree索引是有序的，会将相邻的数据都存储在一起）。<h2 id="索引的使用条件"><a href="#索引的使用条件" class="headerlink" title="索引的使用条件"></a>索引的使用条件</h2></li>
<li>对于非常小的表，大部分情况下简单的全表扫描比建立索引更高效；</li>
<li>对于中到大型的表，索引就非常有效；</li>
<li>但是对于特大型的表，建立和维护索引的代价将会随之增长。这种情况下，需要用到一种技术可以直接区分出需要查询的一组数据，而不是一条记录一条记录地匹配，例如可以使用分区技术。<h2 id="查询性能优化"><a href="#查询性能优化" class="headerlink" title="查询性能优化"></a>查询性能优化</h2><h3 id="使用-Explain-进行分析"><a href="#使用-Explain-进行分析" class="headerlink" title="使用 Explain 进行分析"></a>使用 Explain 进行分析</h3>Explain用来分析SELECT查询语句，开发人员通过分析Explain结果来优化查询语句。</li>
</ul>
<p>比较重要的字段有：</p>
<ul>
<li>select_type: 查询类型，有简单查询、联合查询、子查询等</li>
<li>key： 使用的索引</li>
<li>rows：扫描的行数<h3 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h3><h4 id="1-减少请求的数据量"><a href="#1-减少请求的数据量" class="headerlink" title="1.减少请求的数据量"></a>1.减少请求的数据量</h4></li>
<li>只返回必要的列：最好不要使用SELECT * 语句。</li>
<li>只返回必要的行：使用LIMIT语句来限制返回的数据。</li>
<li>缓存重复查询的数据：使用缓存可以避免在数据库中进行查询，特别在要查询的数据进场被重复查询时，缓存带来的查询性能提升将会是非常明显的。<h4 id="2-减少服务器端扫描的行数"><a href="#2-减少服务器端扫描的行数" class="headerlink" title="2.减少服务器端扫描的行数"></a>2.减少服务器端扫描的行数</h4>最有效的方式是使用索引来覆盖查询。<h3 id="重构查询方式"><a href="#重构查询方式" class="headerlink" title="重构查询方式"></a>重构查询方式</h3><h4 id="1-切分大查询"><a href="#1-切分大查询" class="headerlink" title="1.切分大查询"></a>1.切分大查询</h4>一个大查询如果一次性执行的话，可能一次锁住很多数据，占满整个事务日志、好近系统资源、阻塞很多小的但重要的查询。<figure class="highlight plain"><figcaption><span>from message where create <date_sub(now(),interval 3="" month);```<="" span=""></date_sub(now(),interval></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">	rows_affected=0</span><br><span class="line">	do&#123;</span><br><span class="line">	rows_affected =do_query(&quot;DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000&quot;)</span><br><span class="line">	&#125;while rows_affected &gt;0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="分解大连接查询"><a href="#分解大连接查询" class="headerlink" title="分解大连接查询"></a>分解大连接查询</h4><p>将一个大连接查询分解成对每一个表进行一次单表查询，然后在程序中进行关联，这样做的好处有：</p>
<ul>
<li>让缓存更高效。对于连接查询，如果其中一个表发生变化，那么整个查询缓存就无法实用。而分解后的多个查询，即使其中一个表发生变化，对其他表的查询缓存依然可以使用。</li>
<li>分解成多个单表查询，这些单表查询的缓存结果更可能被其它查询使用到，从而减少成语记录的查询。</li>
<li>减少锁竞争；</li>
<li>在应用层进行连接，可以更容易对数据库进行拆分，从而更容易做到高性能和可伸缩。</li>
<li>查询本身效率也可能会有所提升。例如下面的例子中，使用IN()代替连接查询，可以让MySQL按照ID顺序进行查询，这样可能比随机的连接要更高效。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SELECT * FROM tab</span><br><span class="line">JOIN tag_post ON tag_post.tag_id=tag.id</span><br><span class="line">JOIN post ON tag_post.post_id=post.id</span><br><span class="line">WHERE tag.tag=&apos;mysql&apos;;</span><br><span class="line"></span><br><span class="line">SELECT * FROM tag WHERE tag=&apos;mysql&apos;;</span><br><span class="line">SELECT * FROM tag_post WHERE tag_id=1234;</span><br><span class="line">SELECT * FROM post WHERE post.id IN (123,456,567,9098,8904)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><p>是MySQL默认的事务型存储引擎，只有在需要它不支持的特性时，才考虑使用其他存储引擎。</p>
<p>实现了四个标准的隔离级别，默认级别是可重复读，在可重复读隔离级别下，通过多版本并发控制（MVCC）+间隙锁防止幻读。</p>
<p>主索引是聚簇索引，在索引中保存了数据，从而避免直接读取磁盘，因此对查询性能有很大的提升。</p>
<p>内部做了很多优化，包括从磁盘读取数据时采用的可预测性读、能够加快操作并且自动创建的自适应哈希索引，能够加速插入操作的插入缓冲区等。</p>
<p>支持真正的在线热备份。其它存储引擎不支持在线热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。</p>
<h3 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h3><p>设计简单，数据以紧密格式存储。对于只读数据，或者表比较小，可以容忍修复操作，则依然可以使用它。</p>
<p>提供了大量的特性，包括压缩表，空间数据索引等。</p>
<p>不支持事务。</p>
<p>不支持行级锁，只能对整张表加锁，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在表有读取操作的同时，也可以忘表中插入新的记录，这被称为并发插入。  </p>
<p>可以手工或者自动执行检查和修复操作，但是和事务恢复以及崩溃恢复不同，可能导致一些数据丢失，而且修复操作是非常慢的。</p>
<p>如果指定了DELAY_KEY_WRITE选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机奔溃时会造成索引损坏，需要执行修复操作。</p>
<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h3><ul>
<li>事务： InnoDB是事务型，可以使用commit和rollback语句。</li>
<li>并发：MyISAM只支持包级锁，而InnoDB还支持行级锁。</li>
<li>外键：InnoDB支持外键。</li>
<li>备份：InnoDB支持在线热备份。</li>
<li>崩溃恢复：MyISAM崩溃后发生损坏的概率比InnoDB高很多，而且恢复的速度也更慢。</li>
<li>其他特性：MyISAM支持压缩表和空间数据索引。<h2 id="切分"><a href="#切分" class="headerlink" title="切分"></a>切分</h2><h3 id="水平切分"><a href="#水平切分" class="headerlink" title="水平切分"></a>水平切分</h3>水平切分又称为Sharding，它是将同一个表的记录拆分到多个结构相同的表中。</li>
</ul>
<p>当一个表的数据不断增多时，Sharding是必然的选择，它可以将数据分布到集群的不同节点上，从而缓存单个数据库的压力。<br><img src="https://i.imgur.com/vVKozW2.jpg" alt=""></p>
<h3 id="垂直切分"><a href="#垂直切分" class="headerlink" title="垂直切分"></a>垂直切分</h3><p>垂直切分是将一张表按列切分成多个表，通常是按照列的关系密集程度进行切分，也可以利用垂直切分将京城被使用的列和不经常使用的列且分到不同的表中。</p>
<p>在数据库层面使用垂直切分将按数据库中表的密集程度部署到不同的库中，例如将原来的电商数据库垂直切分成商品数据库，用户数据库等。<br><img src="https://i.imgur.com/FxZ3mEz.jpg" alt="垂直切分"></p>
<h3 id="Sharding策略"><a href="#Sharding策略" class="headerlink" title="Sharding策略"></a>Sharding策略</h3><ul>
<li>哈希取模：hash（key）%N;</li>
<li>范围：可以是ID范围也可以是时间范围；</li>
<li>映射表：使用单独的一个数据库来存储映射关系。<h3 id="Sharding存在的问题"><a href="#Sharding存在的问题" class="headerlink" title="Sharding存在的问题"></a>Sharding存在的问题</h3><h4 id="1-事务问题"><a href="#1-事务问题" class="headerlink" title="1.事务问题"></a>1.事务问题</h4>使用分布式事务来解决，比如XA接口。<h4 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h4>可以将原来的连接分解成多个单表查询，然后在用户程序中进行连接。<h4 id="ID唯一性"><a href="#ID唯一性" class="headerlink" title="ID唯一性"></a>ID唯一性</h4></li>
<li>使用全局唯一ID</li>
<li>为每个分片指定一个ID范围</li>
<li>分布式ID生成器（如Twitter的Snowflake算法）<h2 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h2><h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3>主要涉及三个线程：binlog线程，I/O线程和SQL线程。</li>
<li>binlog线程：负责将主服务器上的数据更改写入二进制日志中。</li>
<li>I/O线程: 负责从主服务器上读取二进制日志，并写入从服务器的重放日志中。</li>
<li>SQL线程：负责读取重放日志并重放其中的SQL语句。<h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3>主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。</li>
</ul>
<p>读写分离能提高性能的原因在于：</p>
<ul>
<li>主从服务器负责各自的读和写，极大程度缓解了锁的争用；</li>
<li>从服务器可以使用MyISAM,提升查询性能以及节约系统开销；</li>
<li>增加冗余，提高可用性。</li>
</ul>
<p>读写分离常用代理方式来实现，代理服务器接受应用层传来的读写请求，然后决定转发到哪个服务器。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/面试/">面试</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/数据库-MySQL/">数据库 MySQL</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://WangLeiHH.github.io/2019/02/28/6-数据库原理/" data-title="6.数据库原理 | 不完整的旋律的博客" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/2019/03/01/7-Redis/" title="7.Redis">
  <strong>上一篇：</strong><br>
  <span>
  7.Redis</span>
</a>
</div>


<div class="next">
<a href="/2019/02/28/5-面向对象/" title="5.面向对象">
 <strong>下一篇：</strong><br> 
 <span>5.面向对象
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#事务"><span class="toc-number">1.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原子性（Atomicity）"><span class="toc-number">1.1.</span> <span class="toc-text">原子性（Atomicity）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一致性"><span class="toc-number">1.2.</span> <span class="toc-text">一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隔离性"><span class="toc-number">1.3.</span> <span class="toc-text">隔离性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#持久性"><span class="toc-number">1.4.</span> <span class="toc-text">持久性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AUTOCOMMIT"><span class="toc-number">1.5.</span> <span class="toc-text">AUTOCOMMIT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并发一致性问题"><span class="toc-number">1.6.</span> <span class="toc-text">并发一致性问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#封锁"><span class="toc-number">2.</span> <span class="toc-text">封锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#封锁粒度"><span class="toc-number">2.1.</span> <span class="toc-text">封锁粒度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#封锁类型"><span class="toc-number">2.2.</span> <span class="toc-text">封锁类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-读写锁"><span class="toc-number">2.2.0.0.1.</span> <span class="toc-text">1.读写锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-意向锁"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.意向锁</span></a></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#封锁协议"><span class="toc-number">2.3.</span> <span class="toc-text">封锁协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-三级封锁协议"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.三级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一级封锁协议"><span class="toc-number">2.3.2.</span> <span class="toc-text">一级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二级封锁协议"><span class="toc-number">2.3.3.</span> <span class="toc-text">二级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三级封锁协议"><span class="toc-number">2.3.4.</span> <span class="toc-text">三级封锁协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#两段锁协议"><span class="toc-number">2.3.5.</span> <span class="toc-text">两段锁协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL隐式与显示锁定"><span class="toc-number">3.</span> <span class="toc-text">MySQL隐式与显示锁定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#隔离级别"><span class="toc-number">4.</span> <span class="toc-text">隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#未提交读-READ-UNCOMMITTED"><span class="toc-number">4.1.</span> <span class="toc-text">未提交读(READ UNCOMMITTED)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提交读（READ-COMMITTED）"><span class="toc-number">4.2.</span> <span class="toc-text">提交读（READ COMMITTED）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可重复读（REPEATABLE-READ）"><span class="toc-number">4.3.</span> <span class="toc-text">可重复读（REPEATABLE READ）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可串行化"><span class="toc-number">4.4.</span> <span class="toc-text">可串行化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多版本并发控制"><span class="toc-number">5.</span> <span class="toc-text">多版本并发控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#版本号"><span class="toc-number">5.1.</span> <span class="toc-text">版本号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隐藏的列"><span class="toc-number">5.2.</span> <span class="toc-text">隐藏的列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL索引"><span class="toc-number">6.</span> <span class="toc-text">MySQL索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-B-Tree索引"><span class="toc-number">6.1.</span> <span class="toc-text">1.B+Tree索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-哈希索引"><span class="toc-number">6.2.</span> <span class="toc-text">2.哈希索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-全文索引"><span class="toc-number">6.3.</span> <span class="toc-text">3.全文索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-空间数据索引"><span class="toc-number">6.4.</span> <span class="toc-text">4.空间数据索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引优化"><span class="toc-number">7.</span> <span class="toc-text">索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-独立的列"><span class="toc-number">7.1.</span> <span class="toc-text">1.独立的列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-前缀索引"><span class="toc-number">7.2.</span> <span class="toc-text">4.前缀索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-覆盖索引"><span class="toc-number">7.3.</span> <span class="toc-text">5.覆盖索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引的优点"><span class="toc-number">8.</span> <span class="toc-text">索引的优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引的使用条件"><span class="toc-number">9.</span> <span class="toc-text">索引的使用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询性能优化"><span class="toc-number">10.</span> <span class="toc-text">查询性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Explain-进行分析"><span class="toc-number">10.1.</span> <span class="toc-text">使用 Explain 进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化数据访问"><span class="toc-number">10.2.</span> <span class="toc-text">优化数据访问</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-减少请求的数据量"><span class="toc-number">10.2.1.</span> <span class="toc-text">1.减少请求的数据量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-减少服务器端扫描的行数"><span class="toc-number">10.2.2.</span> <span class="toc-text">2.减少服务器端扫描的行数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重构查询方式"><span class="toc-number">10.3.</span> <span class="toc-text">重构查询方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-切分大查询"><span class="toc-number">10.3.1.</span> <span class="toc-text">1.切分大查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分解大连接查询"><span class="toc-number">10.3.2.</span> <span class="toc-text">分解大连接查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储引擎"><span class="toc-number">11.</span> <span class="toc-text">存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB"><span class="toc-number">11.1.</span> <span class="toc-text">InnoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyISAM"><span class="toc-number">11.2.</span> <span class="toc-text">MyISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较"><span class="toc-number">11.3.</span> <span class="toc-text">比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#切分"><span class="toc-number">12.</span> <span class="toc-text">切分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#水平切分"><span class="toc-number">12.1.</span> <span class="toc-text">水平切分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#垂直切分"><span class="toc-number">12.2.</span> <span class="toc-text">垂直切分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sharding策略"><span class="toc-number">12.3.</span> <span class="toc-text">Sharding策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sharding存在的问题"><span class="toc-number">12.4.</span> <span class="toc-text">Sharding存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-事务问题"><span class="toc-number">12.4.1.</span> <span class="toc-text">1.事务问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#连接"><span class="toc-number">12.4.2.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ID唯一性"><span class="toc-number">12.4.3.</span> <span class="toc-text">ID唯一性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复制"><span class="toc-number">13.</span> <span class="toc-text">复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#主从复制"><span class="toc-number">13.1.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读写分离"><span class="toc-number">13.2.</span> <span class="toc-text">读写分离</span></a></li></ol></li>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/前端/" title="前端">前端<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/面试/" title="面试">面试<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/vue/" title="vue">vue<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/IO/" title="IO">IO<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/设计模式/" title="设计模式">设计模式<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/设计原则/" title="设计原则">设计原则<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/html/" title="html">html<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/js/" title="js">js<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/COOKIE/" title="COOKIE">COOKIE<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/数据库-MySQL/" title="数据库 MySQL">数据库 MySQL<sup>1</sup></a></li>
			
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">4</span></li></ul>
  </div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/COOKIE/" style="font-size: 10px;">COOKIE</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/数据库-MySQL/" style="font-size: 10px;">数据库 MySQL</a> <a href="/tags/设计原则/" style="font-size: 10px;">设计原则</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer">
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 青葱岁月 我装饰过谁的梦 流年往事 谁又影响了我的整个生命  <br>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="大圣">大圣</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
